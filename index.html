<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional LWE Cipher</title>
    <style>
        :root {
            --primary: #2563eb;
            --dark: #1e293b;
            --light: #f8fafc;
            --error: #dc2626;
        }
        body {
            font-family: 'IBM Plex Mono', monospace;
            line-height: 1.6;
            background: #0f172a;
            color: #e2e8f0;
            margin: 0;
            padding: 2rem;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #1e293b;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
        }
        h1 {
            color: #60a5fa;
            text-align: center;
            margin-bottom: 2rem;
            font-weight: 600;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #334155;
            margin-bottom: 1.5rem;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: #60a5fa;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        textarea, input, select {
            width: 100%;
            padding: 0.75rem;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            color: #f8fafc;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        textarea {
            min-height: 150px;
            font-family: inherit;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }
        button:hover {
            background: #2563eb;
        }
        .btn-group {
            margin: 1.5rem 0;
        }
        .result {
            margin-top: 1rem;
            padding: 1rem;
            background: #334155;
            border-radius: 0.5rem;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .settings-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .setting {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Professional LWE Cipher</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('encrypt-tab')">Шифрование</div>
            <div class="tab" onclick="switchTab('decrypt-tab')">Дешифрование</div>
            <div class="tab" onclick="switchTab('settings-tab')">Настройки</div>
        </div>

        <!-- Encryption Tab -->
        <div id="encrypt-tab" class="tab-content active">
            <div>
                <label for="encrypt-key">Секретный ключ:</label>
                <input type="text" id="encrypt-key" placeholder="Любая длина и символы">
            </div>
            
            <div>
                <label for="encrypt-message">Сообщение:</label>
                <textarea id="encrypt-message" placeholder="Текст для шифрования"></textarea>
            </div>
            
            <div class="btn-group">
                <button onclick="encrypt()">Шифровать</button>
                <button onclick="copyResult('encrypt-result')">Копировать</button>
            </div>
            
            <div id="encrypt-result" class="result"></div>
        </div>

        <!-- Decryption Tab -->
        <div id="decrypt-tab" class="tab-content">
            <div>
                <label for="decrypt-key">Секретный ключ:</label>
                <input type="text" id="decrypt-key" placeholder="Тот же ключ, что и при шифровании">
            </div>
            
            <div>
                <label for="ciphertext">Шифротекст:</label>
                <textarea id="ciphertext" placeholder="Текст для дешифрования"></textarea>
            </div>
            
            <div class="btn-group">
                <button onclick="decrypt()">Дешифровать</button>
                <button onclick="copyResult('decrypt-result')">Копировать</button>
            </div>
            
            <div id="decrypt-result" class="result"></div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="settings-row">
                <div class="setting">
                    <label for="lattice-dimension">Размерность решётки (n):</label>
                    <input type="number" id="lattice-dimension" min="64" max="1024" value="256">
                </div>
                <div class="setting">
                    <label for="modulus">Модуль (q):</label>
                    <input type="number" id="modulus" min="1024" max="2147483647" value="65537">
                </div>
            </div>
            
            <div class="settings-row">
                <div class="setting">
                    <label for="error-sigma">Стандартное отклонение ошибки (σ):</label>
                    <input type="number" id="error-sigma" min="1" max="20" value="6.5" step="0.1">
                </div>
                <div class="setting">
                    <label for="encoding">Кодировка вывода:</label>
                    <select id="encoding">
                        <option value="raw">Raw binary</option>
                        <option value="base64">Base64</option>
                        <option value="hex">HEX</option>
                    </select>
                </div>
            </div>
            
            <div class="btn-group">
                <button onclick="saveSettings()">Сохранить настройки</button>
                <button onclick="resetSettings()">Сбросить</button>
            </div>
            
            <div id="settings-result" class="result"></div>
        </div>
    </div>

    <script>
        // Текущие параметры
        let config = {
            n: 256,
            q: 65537,
            sigma: 6.5,
            encoding: 'raw'
        };

        // Инициализация
        function init() {
            loadSettings();
            applySettingsToUI();
        }

        // Загрузка настроек
        function loadSettings() {
            const saved = localStorage.getItem('lweConfig');
            if (saved) config = JSON.parse(saved);
        }

        // Сохранение настроек
        function saveSettings() {
            config = {
                n: parseInt(document.getElementById('lattice-dimension').value),
                q: parseInt(document.getElementById('modulus').value),
                sigma: parseFloat(document.getElementById('error-sigma').value),
                encoding: document.getElementById('encoding').value
            };
            localStorage.setItem('lweConfig', JSON.stringify(config));
            showResult('settings-result', 'Настройки сохранены', true);
        }

        // Сброс настроек
        function resetSettings() {
            config = { n: 256, q: 65537, sigma: 6.5, encoding: 'raw' };
            applySettingsToUI();
            localStorage.removeItem('lweConfig');
            showResult('settings-result', 'Настройки сброшены', true);
        }

        // Применение настроек к UI
        function applySettingsToUI() {
            document.getElementById('lattice-dimension').value = config.n;
            document.getElementById('modulus').value = config.q;
            document.getElementById('error-sigma').value = config.sigma;
            document.getElementById('encoding').value = config.encoding;
        }

        // Переключение вкладок
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
        }

        // Показать результат
        function showResult(elementId, message, isSuccess = true) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.color = isSuccess ? '#60a5fa' : '#dc2626';
        }

        // Копировать результат
        function copyResult(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text)
                .then(() => showResult(elementId, 'Скопировано!', true))
                .catch(() => showResult(elementId, 'Ошибка копирования', false));
        }

        // Генерация ошибки (гауссово распределение)
        function gaussError() {
            let u, v, s;
            do {
                u = Math.random() * 2 - 1;
                v = Math.random() * 2 - 1;
                s = u * u + v * v;
            } while (s >= 1 || s === 0);
            return Math.floor(config.sigma * u * Math.sqrt(-2 * Math.log(s) / s);
        }

        // Преобразование ключа в вектор решётки
        function keyToVector(keyStr) {
            const vector = new Array(config.n);
            for (let i = 0; i < config.n; i++) {
                let hash = 0;
                for (let j = 0; j < keyStr.length; j++) {
                    hash = (hash << 7) - hash + keyStr.charCodeAt(j) + i;
                    hash |= 0;
                }
                vector[i] = Math.abs(hash) % config.q;
            }
            return vector;
        }

        // Шифрование
        function encrypt() {
            try {
                const keyStr = document.getElementById('encrypt-key').value;
                const message = document.getElementById('encrypt-message').value;
                
                if (!keyStr) throw new Error("Не указан ключ");
                if (!message) throw new Error("Нет сообщения для шифрования");
                
                const keyVector = keyToVector(keyStr);
                const msgBytes = new TextEncoder().encode(message);
                const result = new Uint8Array(msgBytes.length);
                
                for (let i = 0; i < msgBytes.length; i++) {
                    const error = gaussError();
                    const keyIndex = i % config.n;
                    result[i] = (keyVector[keyIndex] + msgBytes[i] + error) % 256;
                }
                
                let output;
                switch(config.encoding) {
                    case 'base64':
                        output = btoa(String.fromCharCode(...result));
                        break;
                    case 'hex':
                        output = Array.from(result).map(b => b.toString(16).padStart(2, '0')).join('');
                        break;
                    default:
                        output = String.fromCharCode(...result);
                }
                
                document.getElementById('ciphertext').value = output;
                showResult('encrypt-result', `Шифротекст (${output.length} символов):\n${output}`, true);
                
            } catch(e) {
                showResult('encrypt-result', "Ошибка: " + e.message, false);
            }
        }

        // Дешифрование
        function decrypt() {
            try {
                const keyStr = document.getElementById('decrypt-key').value;
                const ciphertext = document.getElementById('ciphertext').value;
                
                if (!keyStr) throw new Error("Не указан ключ");
                if (!ciphertext) throw new Error("Нет шифротекста");
                
                let bytes;
                switch(config.encoding) {
                    case 'base64':
                        bytes = new Uint8Array([...atob(ciphertext)].map(c => c.charCodeAt(0)));
                        break;
                    case 'hex':
                        bytes = new Uint8Array(ciphertext.match(/.{1,2}/g).map(b => parseInt(b, 16)));
                        break;
                    default:
                        bytes = new Uint8Array([...ciphertext].map(c => c.charCodeAt(0)));
                }
                
                const keyVector = keyToVector(keyStr);
                const result = new Uint8Array(bytes.length);
                
                for (let i = 0; i < bytes.length; i++) {
                    const keyIndex = i % config.n;
                    let val = (bytes[i] - keyVector[keyIndex]) % 256;
                    if (val < 0) val += 256;
                    result[i] = val;
                }
                
                const plaintext = new TextDecoder().decode(result);
                document.getElementById('message').value = plaintext;
                showResult('decrypt-result', `Расшифровано (${plaintext.length} символов):\n${plaintext}`, true);
                
            } catch(e) {
                showResult('decrypt-result', "Ошибка: " + e.message, false);
            }
        }

        // Инициализация при загрузке
        window.onload = init;
    </script>
</body>
</html>
